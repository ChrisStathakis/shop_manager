from django.shortcuts import render, reverse, get_object_or_404, HttpResponseRedirectfrom django.views.generic import ListView, CreateView, UpdateViewfrom django.utils.decorators import method_decoratorfrom django.contrib.admin.views.decorators import staff_member_requiredfrom django_tables2 import RequestConfigfrom django.contrib import messagesfrom .forms import VoucherForm, ProductRangeForm, VoucherRulesFormfrom .models import Voucher, ProductRange, VoucherRulesfrom catalogue.models import Product, Category, Brandfrom .tables import (VoucherTable, VoucherProductForSelectTable, VoucherCategoryTable, VoucherBrandTable,                     BrandSelectedDataTable, CategorySelectedDataTable, ProductSelectedDataTable)from django_tables2 import RequestConfig@method_decorator(staff_member_required, name='dispatch')class VoucherListView(ListView):    model = Voucher    template_name = 'dashboard/list_page.html'    paginate_by = 30    def get_context_data(self, **kwargs):        context = super(VoucherListView, self).get_context_data(**kwargs)        page_title, back_url, create_url = 'Κουπόνια', reverse('point_of_sale:home'), reverse('vouchers:voucher_create')        queryset_table = VoucherTable(self.object_list)        RequestConfig(self.request).configure(queryset_table)        #  filters        active_filter, date_filter = [True] *2        context.update(locals())        return context@method_decorator(staff_member_required, name='dispatch')class VoucherCreateView(CreateView):    form_class = VoucherForm    model = Voucher    template_name = 'dashboard/form.html'    def get_success_url(self):        return self.new_voucher.get_edit_url()    def get_context_data(self, **kwargs):        context = super(VoucherCreateView, self).get_context_data(**kwargs)        form_title, back_url = 'Δημιουργία Νέου Κουπονιού', reverse('vouchers:voucher_list')        context.update(locals())        return context    def form_valid(self, form):        self.new_voucher = form.save()        messages.success(self.request, 'Το κουπόνι δημιουργήθηκε!')        return super().form_valid(form)@staff_member_requireddef voucher_detail_view(request, pk):    #  voucher    voucher, back_url = get_object_or_404(Voucher, id=pk), reverse('vouchers:voucher_list')    voucher_form = VoucherForm(instance=voucher)    rules, created_ = VoucherRules.objects.get_or_create(voucher=voucher)    rules_form = VoucherRulesForm(instance=rules)    if request.POST:        if request.POST.get('form_type') == 'voucher':            voucher_form = VoucherForm(request.POST, instance=voucher)            if voucher_form.is_valid():                voucher_form.save()                messages.success(request, 'Voucher is updated')        if request.POST.get('form_type') == 'rules':            rules_form = VoucherRulesForm(request.POST, instance=rules)            if rules_form.is_valid():                rules_form.save()                messages.success(request, 'Rules are updated!')        return HttpResponseRedirect(voucher.get_edit_url())    context = locals()    return render(request, 'voucher/voucher_details.html', context)@staff_member_requireddef voucher_choose_products_view(request, pk):    voucher = get_object_or_404(Voucher, id=pk)    product_range = ProductRange.objects.get(voucher=voucher)    rule = VoucherRules.objects.get(voucher=voucher)    rule_type = rule.offer_type    qs = Product.my_query.active()    queryset_table = VoucherProductForSelectTable(qs)    search_url = reverse('vouchers:ajax_search_queryset', kwargs={'pk': voucher.id})    if rule_type == 'Category':        qs = Category.objects.filter(active=True)        queryset_table = VoucherCategoryTable(qs)    elif rule_type == 'brand':        qs = Brand.objects.filter(active=True)        queryset_table = VoucherBrandTable(qs)            selected_data = product_range.included_products.all()    selected_table = ProductSelectedDataTable(selected_data)    if rule_type == 'Category':        selected_data = product_range.included_categories.all()        selected_table = CategorySelectedDataTable(selected_data)    if rule_type == 'brand':        selected_data = product_range.included_brands.all()        selected_table = BrandSelectedDataTable(selected_data)            RequestConfig(request).configure(queryset_table)    context = locals()    return render(request, 'voucher/choose_products.html', context)